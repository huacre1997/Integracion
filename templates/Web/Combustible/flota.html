{% extends 'Web/Combustible/combustible_base.html' %}
{% block procesos%}active{% endblock %}
{% block collapseProcesos %}show{% endblock collapseProcesos %}
{% block flota %}collapse-item active{% endblock  %}
{% block content %}
{% load static %}
<div id="wrapper">
    <div class="container-fluid">
       <ul class="nav nav-tabs" id="myTab" data-tabs="tabs">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="flota-tab" data-toggle="tab" data-target="#flota"
                    type="button" role="tab" aria-controls="flota" aria-selected="true">Registro de
                    Flota</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="flotas-tab" data-toggle="tab" data-target="#flotas"
                    type="button" role="tab" aria-controls="flotas" aria-selected="false">Flota Total</button>
            </li>

        </ul>
          <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="flota" role="tabpanel" aria-labelledby="flota-tab">
        <div class="card">
            <div class="card-body">
                    <form class="row g-3 needs-validation" id="form-flota" novalidate>
                        <div class="col-md-4">
                            <label class="form-label">Placa</label>
                            <select name="placa" id="placa" class="form-select">
                                <option value="0">Seleccione...</option>
                                {% for i in placa %}
                                    <option value="{{ i.id }}">{{i.placa}}</option>
                                {% endfor %}
                                    
                            </select>
                            <div class="invalid-feedback">
                                Este campo es requerido.
                            </div>
                        </div>
                        <div class="col-md-4">
                        <label class="form-label">Marca</label>
                           <input type="text" class="form-control" id="marca" name="marca" disabled>
                            <div class="valid-feedback">
                                Looks good!
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Modelo</label>
                            <input type="text" class="form-control" id="modelo" name="modelo" disabled>

                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Chasis</label>
                            <input type="text" class="form-control" id="chasis" name="chasis" disabled>
                            <div class="invalid-feedback">
                                Please select a valid state.
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Año</label>
                            <input type="number" class="form-control" id="año" name="año" disabled>
                            <div class="invalid-feedback">
                                Please provide a valid city.
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Empresa</label>
                            <div class="input-group">
                                <select class="form-select" name="empresa" id="empresa" aria-label="Example select with button addon">
                                    <option value="0">Seleccione...</option>
                                    {% for i in empresa  %}
                                        <option value="{{ i.id }}">{{ i.nombre }}</option>
                                    {% endfor %}
                                        
                                </select>
                                <button class="btn btn-primary" type="button" id="btn-add-empresa"><i class="fa fa-plus" aria-hidden="true"></i></button>
                                <div class="invalid-feedback">
                                    Este campo es requerido.
                                </div>
                            </div>
                              
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Tipo</label>
                            <input type="text" class="form-control" id="tipo" name="tipo" disabled>

                            <div class="invalid-feedback">
                                Please provide a valid city.
                            </div>
                        </div>
                        <div class="col-12">
                            <button class="btn btn-primary" type="button" id="submit-flota">Guardar</button>
                        </div>
                    </form>
            </div>
        </div>
       </div>
         <div class="tab-pane fade" id="flotas" role="tabpanel" aria-labelledby="flotas-tab">
                <div class="card">
                    <div class="card-body">
                        <table id="tabla_flotas" class="table table-bordered" style="width: 100%">
                            <thead>
                                <th style="width: 0%;">ID</th>
                                <th style="width: 40%;">Placa</th>
                                <th style="width: 50%;">Empresa</th>
                                <th style="width: 10%;"></th>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
       </div>

    </div>

</div>
{% endblock content %}

{% block bottom_scripts %}
<script>
        let modal_flota_edit
     let tabla_flotas
   $("#submit-flota").on("click",function (e){
       let error= 0
       let data=new FormData(document.getElementById("form-flota"))
       if($("#placa").val()=="0"){
           error=1
           $("#placa").addClass("is-invalid").on("change",function() {
               $(this).removeClass("is-invalid")
           })
       }
       if($("#empresa").val()=="0"){
           error=1
           $("#empresa").addClass("is-invalid").on("change",function() {
               $(this).removeClass("is-invalid")
           })
       }
       if(error == 0){
        fetch(window.location.href,{
                    method: "POST",
                    headers: {
                              'X-CSRFToken': csrftoken
                    },
                    body: data

                }).then(data=>data.json()).then(response => {
                    if(response.status == 200){
                        tabla_flotas.ajax.reload()
                        notificacion(1500,"Genial!","success","Flota agregada!")
                        $("#placa").val(0)
                        $("#empresa").val(0)
                        $("#chasis").val("")
                        $("#marca").val("")
                        $("#modelo").val("")
                        $("#año").val("")
                        $("#tipo").val("")

                    }else{
                        notificacion(1500, "Error!","error","Ha ocurrido un error.Revise los campos.")
                        if(response.form.empresa){
                            $("#empresa").addClass("is-invalid").on("change",function(){
                                $(this).removeClass("is-invalid")
                            })
                            $("#empresa").next().text(response.form.empresa[0])
                        }
                        if(response.form.placa){
                            $("#placa").addClass("is-invalid").on("change",function(){
                                $(this).removeClass("is-invalid")
                            })
                            $("#placa").next().text(response.form.placa[0])
                        }                    }
                })
       }
   })
    $("#btn-add-empresa").on("click",function () {
        jc= $.confirm({
                  title: "Registrar empresa",
                  type: 'dark',
                  theme: "material",
                  content:'URL: ../empresa/',
                  icon: 'fas fa-plus-circle',
                  animation: 'left',
                  closeAnimation: 'right',
                  columnClass: "col-lg-6 col-md-6 col-md-offset-3",
                  containerFluid: true, 
  
                  typeAnimated: true,
                  buttons: {
                    guardar: {
                      btnClass: 'btn-success',
                      keys: ['enter', 'shift'],
                      action: function () {
                        this.$content.find(".btn").trigger("click")
                 
                      return false;
                      }
                    },
                    cancel: function () {
        }
                  },
      
                })
      })
    $("#placa").on("change",function(){
        fetch("../../getVehiculo/"+$(this).val()).then(data =>data.json()).then(response=>{
            console.log(response);
            $("#marca").val(response.marca)
            $("#modelo").val(response.modelo)
            $("#año").val(response.ano)
            response.chasis==null ?  $("#chasis").val("") : $("#chasis").val(response.chasis) ;           
            $("#tipo").val(response.tipo)

        })
    })
        tabla_flotas = $("#tabla_flotas").DataTable({
        responsive: true,
                processing:"true",
                        ordering: false,

    
        ajax: {
            url: "{% url 'Web:flotas' %}",
            type: "POST",
            data: {
                "action": "searchData"
            },
            dataSrc: ""
        },
        stateSave: false,
        "lengthMenu": [
            [5, 10, 25, 50, -1],
            [5, 10, 25, 50, "All"]
        ],
        language: {
            "url": "{% static 'language.json' %}",
        },
        columns: [{
                "data": 'id',
                className: "middle text-center"
            }, {
                "data": 'placa',
                className: "middle text-center"
            }, 
        {
                "data": 'empresa',
                className: "middle text-center"
            },
       
       
            {
                "data": null,
                className: "middle text-center",

            },
        ],
        columnDefs: [{
                targets: [0],
                visible: false,
            },

     {
                targets: [-1],
                render: function (row, data, index) {
                    var buttons =
                        '<button class="btn btn-warning btn-sm btn-flota-editar"><i class="fa fa-edit"></i>Editar</button>' +
                   '<button class="btn btn-danger btn-sm btn-delete-flota"><i class="fa fa-ban"></i></button>';

                    return buttons;
                }
            },
        ],
        initComplete: function (settings, json) {


        }
    })
            $(document).on("click", '.btn-delete-flota', function (e) {

      e.preventDefault()
      var tr = tabla_flotas.cell($(this).closest("td")).index();
      var data = tabla_flotas.row(tr.row).data();

        confirmar(function(){
          $("#loadingCharge").css("visibility", "visible")
      $("#spinner").css("visibility", "visible")
          fetch("../flota/delete/" + data.id+"/", {
                method: "POST",
                headers: {
                  'X-CSRFToken': csrftoken
                }}).then(data=>data.json()).then(response=>{
                  
      $("#loadingCharge").css("visibility", "hidden")
      $("#spinner").css("visibility", "hidden")
                  if(response.status==200){

                    tabla_flotas.ajax.reload()
                    notificacion(1500, "Genial!","success", "Flota eliminada!")

                  }

                })
        },"¿Desea eliminar esta Flota?",function () {})

      });
    $(document).on("click", '.btn-flota-editar', function (e) {

e.preventDefault()
var tr = tabla_flotas.cell($(this).closest("td")).index();
var data = tabla_flotas.row(tr.row).data();
modal_flota_edit = $.confirm({
    title: "Editar Flota",
    content: "URL:../flota/" + data.id+"/",
    columnClass: 'col-xl-8 col-lg-8 col-md-10 col-sm-12',
    icon: "fa fa-edit",
    type: "orange",
    theme: "material",
    scrollToPreviousElement: true,
    scrollToPreviousElementAnimate: true,

    buttons: {
        Confirm: {
            text: 'Guardar cambios',
            btnClass: 'btn-orange',

            action: function url(e) {

                this.$content[0].ownerDocument.getElementById("submit_flota_edit").click()
                return false;
            }
        },

        cancel: function () {

        },
    },
    onContentReady: function () {
        // when content is fetched & rendered in DOM
        this.$content.find('form').on('submit', function (e) {
            e.preventDefault();
        });;
    },


});


});
$("#flota-tab").on("click", function () {
window.localStorage.setItem("tab_flota", 1)
})
$("#flotas-tab").on("click", function () {

window.localStorage.setItem("tab_flota", 2)
})

let tab_flota = window.localStorage.getItem("tab_flota")

function select_tab(input) {
$(input).click()
}
if (tab_flota != null) {
if (tab_flota == 1) select_tab("#flota-tab")
if (tab_flota == 2) select_tab("#flotas-tab")
}
</script>
{% endblock bottom_scripts %}