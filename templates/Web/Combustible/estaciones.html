{% extends 'Web/combustible/combustible_base.html' %}
{% block procesos%}active{% endblock %}
{% block collapseProcesos %}show{% endblock collapseProcesos %}
{% block estaciones %}collapse-item active{% endblock  %}
{% block content %}
<div id="wrapper">
  <div class="container-fluid">

    <ul class="nav nav-tabs" id="myTab" data-tabs="tabs">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="home-tab" data-toggle="tab" data-target="#home" type="button" role="tab"
          aria-controls="home" aria-selected="true">Registro de Estaciones de Servicio</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="profile-tab" data-toggle="tab" data-target="#profile" type="button" role="tab"
          aria-controls="profile" aria-selected="false">Asignar productos</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="contact-tab" data-toggle="tab" data-target="#contact" type="button" role="tab"
          aria-controls="contact" aria-selected="false">Contact</button>
      </li>
    </ul>
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
        <div class="card">

          <div class="card-body">
            <p class="card-text">
              <form class="row g-3 needs-validation" id="form_eess" novalidate>
                <div class="col-md-2">
                  <label class="form-label">Código EESS</label>
                  <input type="text" name="codigo" id="codigo" class="form-control">
                  <div class="invalid-feedback">
                    Este campo es requerido
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Nombre EESS</label>
                  <input type="text" name="descripcion" id="descripcion" class="form-control">
                  <div class="invalid-feedback">
                    Este campo es requerido
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Red</label>
                  <input type="text" class="form-control" id="red" name="red">
                  <div class="invalid-feedback">
                    Este campo es requerido
                  </div>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Ubicación</label>
                  <input type="text" class="form-control" id="ubicacion" name="ubicacion">
                  <div class="invalid-feedback">
                    Este campo es requerido
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Dirección</label>
                  <input type="text" class="form-control" id="direccion" name="direccion">
                  <div class="invalid-feedback">
                    Este campo es requerido
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Contacto</label>
                  <input type="text" class="form-control" id="contacto" name="contacto">
                  <div class="invalid-feedback">
                    Este campo es requerido
                  </div>
                </div>
              </form>
              <div class="table-responsive">
                <table class="table  table-hover table-bordered" id="tabla_productos" style="width: 100%;">
                  <thead>
                    <th style="width: 70%;">Producto</th>
                    <th style="width: 25%;"> Precio</th>
                    <th style="width: 5%;"></th>
                  </thead>
                </table>
              </div>
              <div class="col-12">
                <button type="button" class="btn btn-primary" id="submit_eess">Guardar</button>
              </div>
            </p>
          </div>
        </div>


      </div>
      <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
        <div class="card">

          <div class="card-body">
            <select name="prod_eess" class="form-select" id="prod_eess">
              <option value="0">Seleccione estación...</option>
              {% for i in eess  %}
              <option value="{{ i.id }}">{{i.descripcion }}</option>
              {% endfor %}

            </select>
            <br>
            <div class="table-responsive">
              <table class="table  table-hover table-bordered" id="tabla_productos_eess" style="width: 100%;">
                <thead>
                  <th style="display:none;">id</th>
                  <th style="width: 70%;">Producto</th>
                  <th style="width: 25%;"> Precio</th>
                  <th style="width: 5%;"></th>
                </thead>
              </table>
            </div>
            <div class="col-12">
              <button type="button" class="btn btn-primary" id="update_products">Guardar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

{% endblock content %}

{% block bottom_scripts %}
<script>


  function clean_fields(input) {
    $(input).val('');
  }
  $("input").on("keyup", function () {
    $(this).val($(this).val().toUpperCase());
  })
  document.getElementById("submit_eess").addEventListener("click", function () {
    let error = 0

    function validar(input) {
      if ($(input).val() == "") {
        $(input).addClass("is-invalid")
        error = 1
        $(input).on("input", function () {
          $(input).removeClass("is-invalid")
        })
      }
    }
    validar($("#codigo"))
    validar($("#descripcion"))
    validar($("#red"))
    validar($("#ubicacion"))
    validar($("#direccion"))
    let form = document.getElementById("form_eess")
    let data = new FormData(form)
    data.append("producto", JSON.stringify(objeto.items))
    if (error == 0) {
      fetch(window.location.href, {
        method: "POST",
        headers: {
          'X-CSRFToken': csrftoken
        },
        body: data

      }).then(data => data.json()).then(response => {
        console.log(response);
        if (response.status == 200) {
          window.localStorage.clear()
          objeto.items = []
          objeto.list()
          $("#loadingCharge").css("visibility", "hidden")
          $("#spinner").css("visibility", "hidden")
          notificacion(1500, "Genial!", "success", "Estación agregada!")
          $.each($("input"), function (indexInArray, valueOfElement) {
            clean_fields($(valueOfElement))
          });

        } else {
          notificacion(1500, "Error!", "error", "Ha ocurrido un error.Revise los campos.")
          if (response.form.codigo) {
            $("#codigo").addClass("is-invalid").on("input", function () {
              $(this).removeClass("is-invalid")
            })
            $("#codigo").next().text(response.form.codigo[0])
          }
          if (response.form.descripcion) {
            $("#descripcion").addClass("is-invalid").on("input", function () {
              $(this).removeClass("is-invalid")
            })
            $("#descripcion").next().text(response.form.descripcion[0])
          }
        }

      })
    }

  })
  let tabla_producto
  let data = {
    producto: "",
    precio: 0.00,

  }
  let objeto = {
    items: [],
    list: function () {
      tabla_producto = $("#tabla_productos").DataTable({
        searching: false,
        ordering: false,
        paging: false,
        info: false,
        data: this.items,
        destroy: true,
        columns: [


          {
            "data": 'producto',
            className: "middle"
          },


          {
            "data": "precio",
            className: "middle"

          },

          {
            "data": null,
            className: "middle"
          },
        ],

        columnDefs: [
          {
            targets: [0],
            render: function (data, type, row) {

              let $select = $('<select name="producto"  class="form form-select ">' +
                ' <option value="0">Seleccione...</option>' +
                '{% for i in producto  %}' +
                '<option value="{{i.id}}">{{i.descripcion}}</option>' +
                '{% endfor %}' +
                '</select>');
              $select.find('option[value="' + row.producto + '"]').attr('selected', 'selected');
              return $select[0].outerHTML
            }
          },
          {
            targets: [1],
            render: function (data, type, row) {
              return `<input type="number" name="precio" step="0.01" min="0.00" class="form form-control" value="${data}">`;

            }
          },
          {
            targets: [2],
            render: function (data, type, row) {
              if (data.producto != "") {
                return `<button class="btn btn-success btn-remove"><i class="fas fa-check"></i></button>`;

              } else {
                return `<button class="btn btn-primary btn-add"><i class="fas fa-plus"></i></button>`;
              }
            }
          },
        ],

        initComplete: function (settings, json) {
          $(function () {
            function refreshStorage() {
              window.localStorage.removeItem("productos")
              window.localStorage.setItem("productos", JSON.stringify(objeto.items))
            }


            $(".btn-remove").on("click", function () {
              var tr = tabla_producto.cell($(this).closest("td", "li")).index()

              let a = confirmar(function () {
                objeto.items.splice(tr.row, 1)
                objeto.list()
                refreshStorage()

              }, "¿Desea eliminar este producto de la lista?", function () {

              })


            })
            $(".btn-remove").hover(function () {

                $(this).children().remove()
                $(this).append('<i class="fas fa-times"></i>').css("width", "42px")
                $(this).removeClass("btn-success").addClass("btn-danger");
              }, function () {
                $(this).children().remove()
                $(this).append('<i class="fas fa-check"></i>')
                $(this).removeClass("btn-danger").addClass("btn-success");
              }

            )

            $("input[name='precio']").on("change keyup", function (e) {
              e.preventDefault()
              var cant = $(this).val();
              var tr = tabla_producto.cell($(this).closest("td", "li")).index()
              if ($(this).val() == "") {
                $("#submit_eess").prop("disabled", true)
                $(this).addClass("is-invalid")
              } else {
                $("#submit_eess").prop("disabled", false)
                $(this).removeClass("is-invalid")
                let a = 0
                $.each($(".form"), function (index, value) {
                  if ($(value).hasClass("is-invalid")) {
                    a = a + 1
                    $("#submit_eess").prop("disabled", true)
                  }
                });
                if (a == 0) {
                  if (typeof objeto.items[tr.row] !== "undefined") {
                    objeto.items[tr.row].precio = cant;
                    refreshStorage()
                  }
                  $("#submit_eess").prop("disabled", false)

                }
              }
            })
            $("select[name='producto']").on("change", function (e) {
              e.preventDefault()
              $(this).removeClass("is-invalid")
              var cant = $(this).val();
              var tr = tabla_producto.cell($(this).closest("td", "li")).index()
              if ($(this).val() == "0") {
                $("#submit_eess").prop("disabled", true)
                $(this).addClass("is-invalid")
              } else {
                let errorc = 0
                for (let i = 0; i < settings.aoData.length - 1; i++) {
                  if (settings.aoData[i]._aData.producto == cant && i != tr.row) {
                    alerta(1500, "error", "Ese producto ya se encuentra en la tabla")
                    $(this).addClass("is-invalid")
                    errorc = 1
                    break
                  }
                }

                let a = 0
                $.each($(".form"), function (index, value) {
                  if ($(value).hasClass("is-invalid")) {
                    a = a + 1
                    $("#submit_eess").prop("disabled", true)
                  }
                });
                if (a == 0 && errorc == 0) {
                  $("#submit_eess").prop("disabled", false)

                  if (typeof objeto.items[tr.row] !== "undefined") {
                    objeto.items[tr.row].producto = cant;
                    refreshStorage()
                  }

                }
              }

            })



            $("td").on("click", ".btn-add", function (e) {
              let error = 0
              var tr = tabla_producto.cell($(this).closest("td", "li")).index()
              let producto = $("td:eq(0)", tabla_producto.row(tr.row).node()).children()
              let precio = $("td:eq(1)", tabla_producto.row(tr.row).node()).children()


              data.producto = producto.val()
              data.precio = precio.val()



              function valid(that, name, mensaje = "Revise los campos") {
                let ele = $(that).parent().parent().find(name)
                if (ele.val() == "0" || ele.val() == "") {
                  error = 1
                  ele.addClass("is-invalid")
                  ele.on("change input", function () {
                    ele.removeClass("is-invalid")
                  })
                  alerta(1500, "error", mensaje)
                  $(this).prop("disabled", false)

                }
              }

              valid(this, "[name='precio']")
              valid(this, "[name='producto']")

              if (error == 0) {
                $(this).prop("disabled", false)
                objeto.items.push(data)
                window.localStorage.setItem("productos", JSON.stringify(objeto.items))
                data = {
                  producto: "",
                  precio: 0.00,

                }
                $(this).children().remove()
                $(this).append('<i class="fas fa-check"></i>')
                $(this).removeClass("btn-primary").addClass("btn-success")
                $(this).removeClass("btn-add").addClass("btn-remove")
                $(this).hover(function () {

                    $(this).children().remove()
                    $(this).append('<i class="fas fa-times"></i>').css("width",
                      "42px")
                    $(this).removeClass("btn-success").addClass("btn-danger");
                  }, function () {
                    $(this).children().remove()
                    $(this).append('<i class="fas fa-check"></i>')
                    $(this).removeClass("btn-danger").addClass("btn-success");
                  }

                )
                objeto.list()
              }
              console.log(objeto.items)
            })
          })
        }
      });
      tabla_producto.row.add(data).draw()

    }
  }
  if (window.localStorage.getItem("productos")) {
    objeto.items = JSON.parse(window.localStorage.getItem("productos"))
    objeto.list()
    console.log(objeto.items)
  } else {
    objeto.list()


  }
  let data2={
    id:"",
    producto:{id:"",descripcion:""},
    precio:0.00
  }
  let tabla_producto_eess
  let objeto2 = {
    items: [],
    list: function () {
      tabla_producto_eess = $("#tabla_productos_eess").DataTable({
        searching: false,
        ordering: false,
        paging: false,
        info: false,
        data: this.items,
        destroy: true,
        columns: [
          {
            "data": 'id',
            className: null
          },
         {
            "data": 'producto.id',
            className: "middle"
          },

          {
            "data": "precio",
            className: "middle"

          },

          {
            "data": null,
            className: "middle"
          },
        ],
        columnDefs: [
        {
                "targets": [ 0],
                "visible": false,
            },
          {
            targets: [1],
            render: function (data, type, row) {
              let $select = $('<select name="producto"  class="form form-select ">' +
                ' <option value="0">Seleccione...</option>' +
                '{% for i in producto  %}' +
                '<option value="{{i.id}}">{{i.descripcion}}</option>' +
                '{% endfor %}' +
                '</select>');
              $select.find('option[value="' + data + '"]').attr('selected', 'selected');
              return $select[0].outerHTML
            }
          },
          {
            targets: [2],
            render: function (data, type, row) {
              return `<input type="number" name="precio" step="0.01" min="0.00" class="form form-control" value="${data}">`;
            }
          },
          {
            targets: [3],
            render: function (data, type, row) {
    
              if (data.producto.id != "") {
                return `<button class="btn btn-success btn-remove"><i class="fas fa-check"></i></button>`;

              } else {
                return `<button class="btn btn-primary btn-add"><i class="fas fa-plus"></i></button>`;
              }
            }
          },
        ],

        initComplete: function (settings, json) {
          $(function () {
                    $(".btn-remove").on("click", function () {
              var tr = tabla_producto_eess.cell($(this).closest("td", "li")).index()

              let a = confirmar(function () {
                objeto2.items.splice(tr.row, 1)
                objeto2.list()

              }, "¿Desea eliminar este producto de la lista?", function () {

              })


            })
            $(".btn-remove").hover(function () {

                $(this).children().remove()
                $(this).append('<i class="fas fa-times"></i>').css("width", "42px")
                $(this).removeClass("btn-success").addClass("btn-danger");
              }, function () {
                $(this).children().remove()
                $(this).append('<i class="fas fa-check"></i>')
                $(this).removeClass("btn-danger").addClass("btn-success");
              }

            )

            $("input[name='precio']").on("change keyup", function (e) {
              e.preventDefault()
              var cant = $(this).val();
              var tr = tabla_producto_eess.cell($(this).closest("td", "li")).index()
              if ($(this).val() == "") {
                $("#update_products").prop("disabled", true)
                $(this).addClass("is-invalid")
              } else {
                $("#update_products").prop("disabled", false)
                $(this).removeClass("is-invalid")
                let a = 0
                $.each($(".form"), function (index, value) {
                  if ($(value).hasClass("is-invalid")) {
                    a = a + 1
                    $("#update_products").prop("disabled", true)
                  }
                });
                if (a == 0) {
                  if (typeof objeto2.items[tr.row] !== "undefined") {
                    objeto2.items[tr.row].precio = cant;
                  }
                  $("#update_products").prop("disabled", false)

                }
              }
            })
            $("select[name='producto']").on("change", function (e) {
              e.preventDefault()
              console.log("aea")
              $(this).removeClass("is-invalid")
              var cant = $(this).val();
              var tr = tabla_producto_eess.cell($(this).closest("td", "li")).index()
              if ($(this).val() == "0") {
                $("#update_products").prop("disabled", true)
                $(this).addClass("is-invalid")
              } else {
                let errorc = 0
                for (let i = 0; i < settings.aoData.length - 1; i++) {
                  console.log(settings.aoData[i])
                  if (settings.aoData[i]._aData.producto.id == cant && i != tr.row) {
                    alerta(1500, "error", "Ese producto ya se encuentra en la tabla")
                    $(this).addClass("is-invalid")
                    errorc = 1
                    break
                  }
                }

                let a = 0
                $.each($(".form"), function (index, value) {
                  if ($(value).hasClass("is-invalid")) {
                    a = a + 1
                    $("#update_products").prop("disabled", true)
                  }
                });
                if (a == 0 && errorc == 0) {
                  $("#update_products").prop("disabled", false)

                  if (typeof objeto2.items[tr.row] !== "undefined") {
                    objeto2.items[tr.row].producto.id = cant;
                  }

                }
              }

            })
            $("td").on("click", ".btn-add", function (e) {
              let error = 0
              var tr = tabla_producto_eess.cell($(this).closest("td", "li")).index()
              let producto = $("td:eq(0)", tabla_producto_eess.row(tr.row).node()).children()
              console.log(producto)
              let precio = $("td:eq(1)", tabla_producto_eess.row(tr.row).node()).children()
              data2.producto.id= producto.val()
              data2.precio = precio.val()
              data2.id=""
              function valid(that, name, mensaje = "Revise los campos") {
                let ele = $(that).parent().parent().find(name)
                if (ele.val() == "0" || ele.val() == "") {
                  error = 1
                  ele.addClass("is-invalid")
                  ele.on("change input", function () {
                    ele.removeClass("is-invalid")
                  })
                  alerta(1500, "error", mensaje)
                  $(this).prop("disabled", false)

                }
              }

              valid(this, "[name='precio']")
              valid(this, "[name='producto']")

              if (error == 0) {
                $(this).prop("disabled", false)
                objeto2.items.push(data2)
                data2 = {
                  id:"",
                  producto:{
                    id:"",
                    descripcion:""
                  },
                  precio: 0.00,

                }
                $(this).children().remove()
                $(this).append('<i class="fas fa-check"></i>')
                $(this).removeClass("btn-primary").addClass("btn-success")
                $(this).removeClass("btn-add").addClass("btn-remove")
                $(this).hover(function () {

                    $(this).children().remove()
                    $(this).append('<i class="fas fa-times"></i>').css("width",
                      "42px")
                    $(this).removeClass("btn-success").addClass("btn-danger");
                  }, function () {
                    $(this).children().remove()
                    $(this).append('<i class="fas fa-check"></i>')
                    $(this).removeClass("btn-danger").addClass("btn-success");
                  }

                )
                objeto2.list()
                console.log(objeto2)
              }
            })
          })
        }
      });
      tabla_producto_eess.row.add(data2).draw()

    }
  }

  $("#prod_eess").on("change", function () {
    fetch("../../combustible/get-products/" + $(this).val() + "/").then(data => data.json()).then(res => {
      console.log(res)
      objeto2.items=res.data
      objeto2.list()
    })

  })
  $("#update_products").on("click",function(){
    fetch("../get-products/"+$("#prod_eess").val()+"/",{
      method:"POST",
      headers: {
                              'X-CSRFToken': csrftoken
                            },
      body:JSON.stringify(objeto2.items)
    }).then(data =>data.json()).then(res=>{
      if(res.status==200){
        $("#loadingCharge").css("visibility", "hidden")
          $("#spinner").css("visibility", "hidden")
          notificacion(1500, "Genial!", "success", "Estación actualizada!")
          $("#prod_eess").trigger("change")
      }
        })
     
  })
</script>
{% endblock bottom_scripts %}