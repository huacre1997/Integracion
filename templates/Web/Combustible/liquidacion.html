{% extends 'Web/Combustible/combustible_base.html' %}
{% block reportes%}active{% endblock %}
{% block collapseReportes %}show{% endblock collapseReportes %}
{% block liquidacion %}collapse-item active{% endblock  %}
{% block content %}
{% load static %}
<div id="wrapper">
  <div class="container-fluid">
    <div class="card">
      <h5 class="card-header"><i class="fas fa-car"></i>&nbsp;Liquidación de Factura</h5>
      <div class="card-body">
        <div class="row g-3">
          {% csrf_token %}
          <div class="col-lg-10">
            <input type="file" class="form-control" name="abastecimiento_xlsx" id="file">
          </div>
          <div class="col-lg-2">
            <button type="submit" id="send_excel" class="btn btn-success"><i
                class="fas fa-file-excel"></i>&nbsp;Importar Excel</button>

          </div>
        </div>
        <div class="row g-3">
          <div class="col-4">
            <label for="">Fecha</label>
            <input type="text" name="date_ranger" class="form-control" id="date_ranger" autocomplete="off">

          </div>
          <div class="col-3">
            <label for="">Factura</label>
            <input type="text" name="factura" id="factura" class="form-control">
          </div>
          <div class="col-3">
            <label for="">Código EESS</label>
            <select name="eess" id="eess" class="form-select">
              <option value="0">Seleccione...</option>

              {% for i in eess  %}
              <option value="{{ i.id }}">{{ i.codigo }}</option>

              {% endfor %}

            </select>
          </div>
          <div class="col-2">
            <label for="" class="invisible">Buscar</label></label><button id="search"
              class="btn btn-primary btn-block"><i class="fa fa-search" aria-hidden="true"></i>&nbsp;Buscar</button>
          </div>
        </div>
        <br>
        <div class="table-responsive">
          <table class="table display responsive nowrap" id="tabla_liquidacion" style="width:100%">
            <thead>
              <th>Placa</th>
              <th> Marca</th>
              <th>Modelo</th>
              <th>Año</th>
              <th>Conductor</th>
              <th>Fecha</th>
              <th>% Cargado</th>
              <th>Tipo</th>
              <th>EESS</th>
              <th>KM</th>
              <th>Recorrido</th>
              <th>Producto</th>
              <th>Gal.Abast.</th>
              <th>Precio</th>
              <th>Monto</th>
              <th>Voucher</th>
              <th>Factura</th>
            </thead>
            <tfoot>
              <tr>
                <th colspan="14" style="text-align:right">Total:</th>
                <th id="total"></th>
              </tr>
            </tfoot>
          </table>

        </div>

      </div>
    </div>
  </div>

</div>
{% endblock content %}

{% block bottom_scripts %}
<script src="//cdn.datatables.net/plug-ins/1.10.24/api/sum().js"></script>
<script>
  let date_range = null
  let date_now = new moment().format('YYYY-MM-DD');
  let tabla_liquidacion
  let parameters = {
    factura: "",
    eess: "",
    start_date: "",
    end_date: "",
  }
  load()
  $("#año").on("input", function () {
    parameters.año = $(this).val()
  })
  $("#mes").on("change", function () {
    parameters.mes = $(this).val()
  })
  $("#eess").on("change", function () {
    parameters.eess = $(this).val()
  })
  $("#factura").on("change", function () {
    parameters.factura = $(this).val()
  })
  $("#search").on("click", function () {
    load()
  })

  function load() {
    tabla_liquidacion = $("#tabla_liquidacion").DataTable({
      processing: "true",
      "ordering": false,
      lengthChange: false,


      responsive: true,
      destroy: true,
      "lengthMenu": [
        [10, 25, 50, -1],
        [10, 25, 50, "All"]
      ],

      language: {
        "url": "{% static 'language.json' %}"
      },
      ajax: {
        url: window.location.pathname,
        type: "POST",
        data: parameters,
        dataSrc: ""
      },
      buttons: [{
          extend: "excelHtml5",
          text: "<i class='fas fa-file-excel'></i>&nbsp;Exportar a Excel",
          titleAttr: "excel",
          className: "btn btn-success"
        },
        {
          extend: "pdfHtml5",
          text: "<i class='fas fa-file-pdf'></i>&nbsp;Exportar a PDF",
          titleAttr: "PDF",
          className: "btn btn-danger",
          download: "open",
          orientation: "landscape",
          pageSize: "LEGAL",

        },
        {
          extend: "print",
          text: "<i class='fas fa-print'></i>&nbsp;Imprimir",
          className: "btn btn-secondary",
          download: "open",
          orientation: "landscape",
          pageSize: "LEGAL",

        }
      ],
      columns: [


        {
          "data": 'placa.placa',
          className: "middle"
        },


        {
          "data": "placa.marca",
          className: "middle"

        },
        {
          "data": "placa.modelo",
          className: "middle"

        },
        {
          "data": 'placa.ano',
          className: "middle"
        },
        {
          "data": 'conductor',
          className: "middle"
        },

        {
          "data": 'abast.fecha',
          className: "middle"
        },

        {
          "data": 'cargado',
          className: "middle"
        },
        {
          "data": 'abast.tipo',
          className: "middle"
        },

        {
          "data": "abast.estacion",
          className: "middle"
        },

        {
          "data": "km",
          className: "middle"
        },
        {
          "data": "recorrido",
          className: "middle"
        },
        {
          "data": "abast.producto",
          className: "middle"
        },

        {
          "data": "volumen",
          className: "middle"
        },
        {
          "data": "abast.precio",
          className: "middle"
        }, {
          "data": null,
          className: "middle"
        },
        {
          "data": "voucher",
          className: "middle"
        }, {
          "data": "factura",
          className: "middle"
        },
      ],
      columnDefs: [

        // {
        //   targets: [8],
        //   render: function (data, type, row) {
        //     if (row.cargado == 50) {
        //       return parseFloat(row.rend_km / row.rend_prom).toFixed(2)
        //     } else if (row.cargado == 0) {
        //       return parseFloat(row.rend_km / row.rend_vacio).toFixed(2)

        //     }
        //     return parseFloat(row.rend_km / row.rend_cargado).toFixed(2)
        //   }
        // },
        {
          targets: [-3],
          render: function (data, type, row) {
            return (parseFloat(row.abast.precio) * parseFloat(row.volumen)).toFixed(2)
          }
        },
      ],

      initComplete: function (settings, json) {
        let sum = 0
        for (let i = 0; i < settings.aoData.length; i++) {
          sum += parseFloat(settings.aoData[i].anCells[13].textContent)
        }
        $("#total").html(sum.toFixed(2))
        tabla_liquidacion.buttons().container()
          .appendTo('#tabla_liquidacion_wrapper .col-md-6:eq(0)');
      }
    })
  }
  $('input[name="date_ranger"]').daterangepicker({
    autoUpdateInput: false,

    locale: {
      format: 'YYYY-MM-DD'
    },
    opens: 'right'
  }).on("apply.daterangepicker", function (ev, picker) {
    $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));

    date_range = picker;

    parameters.start_date = date_range.startDate.format("YYYY-MM-DD")
    parameters.end_date = date_range.endDate.format("YYYY-MM-DD")
    load()

  }).on('cancel.daterangepicker', function (ev, picker) {
    date_range = picker;
    $(this).val("");
    parameters.start_date = ""
    parameters.end_date = ""

    load();
  });
  $("#eess").on("change", function () {
    ($(this).val() == 0) ? parameters.eess = "": parameters.eess = $(this).val()
    load()
  })
  $("#factura").on("input", function () {

    parameters.año = $(this).val()
    load()
    if ($(this).val().length == 0) {
      parameters.año = ""
      load()
    }
  })
  document.getElementById('send_excel').onclick = function (e) {
    let files = document.getElementById("file").files;
    let file = files[0];
    console.log(file.name);
    let form = new FormData()
    form.append("file", file)
    fetch("{% url 'Web:import-abastecimiento' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrftoken,
      },
      body: form

    }).then(data => data.json()).then(res => {
      console.log(res)
      let mensajes = []
      for (let a = 0; a < res.length; a++) {
        let found1=true 
        let found2 =true 
        let found3=true 
        let ret=0
        tabla_liquidacion.rows().eq(0).each(function (index) {

          let row = tabla_liquidacion.row(index);
          let data = row.data();
          if(ret==0){
         
          if (res[a].factura != null && res[a].voucher == null) {
            if (data.factura == res[a].factura) {
              found1=true
              if (res[a].placa != data.placa.placa) {
                mensajes.push(`La placa  ${data.placa.placa}  no coincide con la factura ${res[a].factura}`)
                equal_1 = 1
              }
              if (res[a].precio[0] != data.abast.precio) {
                equal = 1
                mensajes.push(
                  `El  precio  ${data.abast.precio} del producto no coincide con la factura ${res[a].factura}`
                )
              }
              if (res[a].total[0] != data.total) {
                mensajes.push(`El  total  ${data.total}  no coincide con la factura ${res[a].factura}`)

                equal = 1
              }

              if (res[a].volumen[0] != data.volumen) {
                mensajes.push(`El  volumen  ${data.volumen}  no coincide con la factura ${res[a].factura}`)

                equal = 1
              }
              ret=1;

            }else{
              found1=false
            }
          } else
          if (res[a].voucher != null && res[a].factura == null) {
            if (data.voucher == res[a].voucher) {
              found2 = true
              if (res[a].placa != data.placa.placa) {
                mensajes.push(`La placa  ${data.placa.placa}  no coincide con el voucher  ${res[a].voucher}`)
                equal = 1
              }
              if (res[a].precio[0] != data.abast.precio) {
                equal = 1
                mensajes.push(
                  `El  precio  ${data.abast.precio} del producto no coincide con el voucher ${res[a].voucher}`
                )
              }
              if (res[a].total[0] != data.total) {
                mensajes.push(`El  total  ${data.total}no coincide con el voucher ${res[a].voucher}`)

                equal = 1
              }

              if (res[a].volumen[0] != data.volumen) {
                mensajes.push(`El  volumen  ${data.volumen}  no coincide con el voucher ${res[a].voucher}`)

                equal = 1
              }
              ret=1;

            } else{
              found2=false
            }
          } else
          if (res[a].voucher != null && res[a].factura != null) {
            if (data.voucher == res[a].voucher && data.factura == res[a].factura) {
              found3 = true
              if (res[a].placa != data.placa.placa) {
                mensajes.push(
                  `La placa  ${data.placa.placa}  no coincide con el voucher  ${res[a].voucher} y factura  con el voucher  ${res[a].factura}`
                )
                equal = 1
              }
              if (res[a].precio[0] != data.abast.precio) {
                equal = 1
                mensajes.push(
                  `El  precio  ${data.abast.precio} del producto no coincide con el voucher ${res[a].voucher}  y factura  con el voucher  ${res[a].factura}`
                )
              }
              if (res[a].total[0] != data.total) {
                mensajes.push(
                  `El  total  ${data.total}no coincide con el voucher ${res[a].voucher}  y factura  con el voucher  ${res[a].factura}`
                )

                equal = 1
              }

              if (res[a].volumen[0] != data.volumen) {
                mensajes.push(
                  `El  volumen  ${data.volumen}  no coincide con el voucher ${res[a].voucher}  y factura  con el voucher  ${res[a].factura}`
                )

                equal = 1
              }
              ret=1;

            }else{
              found3=false
            }
          }

        }
        })
        if(!found1 ){
          mensajes.push(`La factura  ${res[a].factura} no se encuentra en la tabla`)

        }
        if(!found2){
          mensajes.push(`El voucher  ${res[a].voucher}  no se encuentra en la tabla`)

        }
        if(!found3){
          mensajes.push(`El voucher  ${res[a].voucher} y la factura  ${res[a].factura} no se encuentra en la tabla`)

        }


      }
      console.log(mensajes)
      var doc = new jsPDF();
      doc.setFontSize(12);

doc.text(20, 20, 'Observaciones:');
      for (let index = 0; index < mensajes.length; index++) {
        let mensaje = mensajes[index];
          doc.text(20, (index+1)*10+20, "- "+mensaje);
        
      }
// Optional - set properties on the document
// doc.setProperties({
//     title: 'Title',
//     subject: 'This is the subject',
//     author: 'James Hall',
//     keywords: 'generated, javascript, web 2.0, ajax',
//     creator: 'MEEE'
// });

window.open(doc.output('bloburl'))



// Output as Data URI
  // Swal.fire({
      //   title: 'Advertencia',
      //   icon: 'info',
      //   html: '<li>' + mensajes.join('</li><li>') + '</li>',
      //   showCloseButton: true,
      //   showCancelButton: true,
      //   focusConfirm: false,
      //   confirmButtonText: '<i class="fa fa-thumbs-up"></i> Ok!',
      //   confirmButtonAriaLabel: 'Thumbs up, great!',
      //   cancelButtonText: '<i class="fa fa-thumbs-down"></i>',
      //   cancelButtonAriaLabel: 'Thumbs down'
      // })
    })
  };
</script>
{% endblock bottom_scripts %}